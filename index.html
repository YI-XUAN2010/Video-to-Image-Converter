<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>影片轉圖片工具</title>

    <style>
        :root {
            --bg-color: #f4f7f9; --text-color: #333; --container-bg: #fff; --controls-bg: #ecf0f1; --input-border-color: #bdc3c7; --header-text-color: #2c3e50; --label-text-color: #34495e; --value-text-color: #e74c3c; --shadow-color: rgba(0,0,0,0.1); --status-bg: #eaf2f8; --custom-controls-bg: #fff; --custom-controls-border: #ddd; --menu-bg: #ffffff; --menu-shadow: rgba(0, 0, 0, 0.15); --accent-color: #007bff; --accent-color-hover: #0056b3;
        }
        body[data-theme="dark"] {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e; --controls-bg: #2c2c2c; --input-border-color: #555; --header-text-color: #e0e0e0; --label-text-color: #c0c0c0; --value-text-color: #ff6b6b; --shadow-color: rgba(0,0,0,0.4); --status-bg: #333; --custom-controls-bg: #252525; --custom-controls-border: #444; --menu-bg: #333333; --menu-shadow: rgba(0, 0, 0, 0.5); --accent-color: #3498db; --accent-color-hover: #2980b9; 
        }
        html, body { min-height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box; display: flex; justify-content: center; align-items: flex-start; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 1000px; background-color: var(--container-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px var(--shadow-color); transition: background-color 0.3s; margin-top: 10px; }
        @media (min-width: 600px) { body { align-items: center; } .container { padding: 30px; margin-top: 0; } }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .icon-container { position: relative; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; line-height: 1; transition: opacity 0.2s; }
        .icon-btn:hover { background-color: var(--controls-bg); }
        .menu-popup { position: absolute; top: 45px; background-color: var(--menu-bg); border-radius: 8px; box-shadow: 0 2px 10px var(--menu-shadow); padding: 10px; z-index: 100; width: 200px; }
        #settings-menu { left: 0; } #lang-menu { right: 0; } #account-menu { right: 0; }
        .menu-popup .menu-section { padding: 8px; } .menu-popup .menu-section label { display: block; margin-bottom: 10px; font-weight: bold; } .menu-popup .menu-options label { display: flex; align-items: center; gap: 8px; font-weight: normal; padding: 5px; border-radius: 4px; }

        h1 { text-align: center; color: var(--header-text-color); margin: 0 0 10px 0; overflow: hidden; }
        
        #plan-display { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 16px; color: var(--accent-color); }

        #key-section { background-color: var(--controls-bg); padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; }
        #key-section label { display: block; margin-bottom: 10px; font-size: 18px; font-weight: bold; color: var(--label-text-color); }
        #key-input { width: 100%; max-width: 320px; padding: 12px; border-radius: 5px; border: 1px solid var(--input-border-color); background-color: var(--container-bg); color: var(--text-color); box-sizing: border-box; font-family: 'Courier New', Courier, monospace; font-size: 16px; text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 15px; }
        .key-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #key-submit-btn, #trial-btn { padding: 12px 20px; font-size: 16px; font-weight: bold; color: #fff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #key-submit-btn { background-color: var(--accent-color); } #key-submit-btn:hover { background-color: var(--accent-color-hover); }
        #trial-btn { background-color: #6c757d; } #trial-btn:hover { background-color: #5a6268; }
        
        #file-selection-area { margin-bottom: 20px; opacity: 0.5; pointer-events: none; transition: opacity 0.5s; }
        #file-selection-area.unlocked { opacity: 1; pointer-events: auto; }

        .controls { background-color: var(--controls-bg); display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; padding: 20px; border-radius: 8px; transition: opacity 0.5s, filter 0.5s; }
        .control-group { display: flex; flex-direction: column; }
        .controls.disabled { opacity: 0.5; pointer-events: none; filter: blur(2px); }
        
        label { margin-bottom: 8px; font-weight: bold; color: var(--label-text-color); }
        .file-input-wrapper { display: flex; align-items: center; gap: 10px; border: 1px solid var(--input-border-color); background-color: var(--container-bg); padding: 5px; border-radius: 5px; }
        #video-input { display: none; } #custom-file-btn { background-color: #6c757d; color: white; padding: 5px 12px; border-radius: 4px; border: none; cursor: pointer; white-space: nowrap; }
        #file-name-display { flex-grow: 1; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; padding-left: 5px; opacity: 0.7; }
        #cancel-file-btn { background: none; border: none; font-size: 24px; color: var(--text-color); cursor: pointer; line-height: 1; padding: 0 5px; } #cancel-file-btn:hover { color: var(--value-text-color); }
        input[type="number"] { border: 1px solid var(--input-border-color); padding: 10px; border-radius: 5px; font-size: 14px; width: 100%; box-sizing: border-box; background-color: var(--container-bg); color: var(--text-color); }
        input[type="range"] { width: 100%; }
        #fps-value, #quality-value { color: var(--value-text-color); font-weight: bold; }
        .dimension-input { margin-bottom: 15px; } .dimension-input:last-child { margin-bottom: 0; } .dimension-input label { display: block; margin-bottom: 5px; font-weight: normal; }
        .aspect-ratio-lock-container { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; cursor: pointer; } .aspect-ratio-lock-container label { font-weight: normal; }
        input[type="checkbox"] { width: 16px; height: 16px; }
        .format-options, .dimension-mode-options { display: flex; flex-wrap: wrap; gap: 20px; } .format-options label, .dimension-mode-options label { display: flex; align-items: center; gap: 5px; font-weight: normal; }
        input:disabled { cursor: not-allowed; opacity: 0.7; }
        label.disabled { color: var(--text-color); opacity: 0.5; }
        #custom-dimension-controls { margin-top: 15px; padding: 15px; background-color: var(--custom-controls-bg); border-radius: 6px; border: 1px solid var(--custom-controls-border); }
        .hidden { display: none !important; }
        #start-btn { padding: 12px 20px; }
        #cancel-conversion-btn { padding: 12px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #cancel-conversion-btn:hover { background-color: #c0392b; }
        #status { text-align: center; font-size: 18px; padding: 15px; background-color: var(--status-bg); border-radius: 5px; margin-bottom: 20px; font-weight: 500; }
        #output-container h2 { border-bottom: 2px solid var(--controls-bg); padding-bottom: 10px; margin-bottom: 20px; }
        #image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .thumbnail { width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 5px var(--shadow-color); object-fit: cover; }
        #download-all-btn { background-color: #2ecc71; margin-bottom: 20px; } #download-all-btn:hover { background-color: #27ae60; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--container-bg); padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 90%; text-align: center; }
        .modal-content h2 { margin: 0 0 15px 0; color: var(--header-text-color); }
        .modal-content p { margin: 0 0 25px 0; font-size: 16px; }
        .modal-content p strong { color: var(--accent-color); font-size: 18px; }
        .modal-content button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; color: #fff; background-color: var(--accent-color); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-bottom: 10px; }
        .modal-content button:hover { background-color: var(--accent-color-hover); }
        .modal-content .close-btn { background-color: #6c757d; }
        .modal-content .close-btn:hover { background-color: #5a6268; }
        
        #plans-comparison-modal .modal-content { max-width: 700px; }
        .plans-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .plans-table th, .plans-table td { border: 1px solid var(--custom-controls-border); padding: 12px; }
        .plans-table th { background-color: var(--controls-bg); }
        .plans-table td:first-child { text-align: left; font-weight: bold; }
        .plans-table .check { color: #2ecc71; font-size: 20px; font-weight: bold; }
        .plans-table .cross { color: #e74c3c; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-bar">
            <div class="icon-container"> <button id="settings-btn" class="icon-btn" aria-label="設定">⚙️</button> <div id="settings-menu" class="menu-popup hidden"> <div class="menu-section"> <label data-i18n-key="theme">主題</label> <div class="menu-options"> <label><input type="radio" name="theme" value="light"> <span data-i18n-key="themeLight">淺色</span></label> <label><input type="radio" name="theme" value="dark"> <span data-i18n-key="themeDark">深色</span></label> <label><input type="radio" name="theme" value="system"> <span data-i18n-key="themeSystem">視裝置而定</span></label> </div> </div> </div> </div>
            <div class="icon-container"> <button id="account-btn" class="icon-btn hidden" aria-label="帳號">👤</button> </div>
            <div class="icon-container"> <button id="lang-btn" class="icon-btn" aria-label="語言">🌐</button> <div id="lang-menu" class="menu-popup hidden"> <div class="menu-section"> <label data-i18n-key="language">語言</label> <div class="menu-options"> <label><input type="radio" name="lang" value="zh-TW"> 繁體中文</label> <label><input type="radio" name="lang" value="zh-CN"> 简体中文</label> <label><input type="radio" name="lang" value="en"> English</label> <label><input type="radio" name="lang" value="ja"> 日本語</label> <label><input type="radio" name="lang" value="ko"> 한국어</label> </div> </div> </div> </div>
        </div>
        <h1 data-i18n-key="title">影片轉圖片工具</h1>
        <div id="plan-display"></div>
        
        <div id="key-section">
            <label for="key-input" data-i18n-key="keyPrompt">請輸入產品金鑰以使用完整功能</label>
            <!-- ⭐ HTML 修改處：修正金鑰最大長度 -->
            <input type="text" id="key-input" data-i18n-placeholder-key="keyPlaceholder" maxlength="17">
            <div class="key-buttons">
                <button id="key-submit-btn" data-i18n-key="unlockButton">驗證金鑰</button>
                <button id="trial-btn" data-i18n-key="trialButton">使用試用版</button>
            </div>
        </div>

        <div id="file-selection-area">
            <div class="control-group"> <label for="video-input" data-i18n-key="step1">1. 選擇影片檔案：</label> <div class="file-input-wrapper"> <input type="file" id="video-input" accept="video/*"> <button id="custom-file-btn" data-i18n-key="selectFile">選擇檔案</button> <span id="file-name-display" data-i18n-key="noFileChosen">未選擇任何檔案</span> <button id="cancel-file-btn" class="hidden" data-i18n-key="cancel" aria-label="Cancel selection">&times;</button> </div> </div> 
        </div>

        <div class="controls disabled">
             <div class="control-group"> <label data-i18n-key="step2">2. 選擇輸出格式：</label> <div class="format-options"> <label><input type="radio" name="format" value="image/jpeg" checked> JPG</label> <label id="png-label"><input type="radio" name="format" value="image/png"> PNG</label> </div> </div> 
             <div class="control-group"> <label for="fps-slider"><span data-i18n-key="step3">3. 選擇擷取率 (FPS)：</span><span id="fps-value">10</span> FPS</label> <input type="range" id="fps-slider" min="1" max="60" value="10"> </div> 
             <div class="control-group" id="quality-control-group"> <label for="quality-slider"><span data-i18n-key="step4">4. 選擇圖片畫質</span> <span data-i18n-key="step4note">(僅 JPG 有效)</span>：<span id="quality-value">80</span>%</label> <input type="range" id="quality-slider" min="1" max="100" value="80"> </div> 
             <div class="control-group"> <label data-i18n-key="step5">5. 選擇輸出尺寸：</label> <div class="dimension-mode-options"> <label><input type="radio" name="dimension-mode" value="original" checked> <span data-i18n-key="useOriginalSize">使用原始尺寸</span></label> <label id="custom-dim-label"><input type="radio" name="dimension-mode" value="custom"> <span data-i18n-key="useCustomSize">自訂尺寸</span></label> </div> <div id="custom-dimension-controls" class="hidden"> <div class="aspect-ratio-lock-container"> <input type="checkbox" id="aspect-ratio-lock" checked> <label for="aspect-ratio-lock" data-i18n-key="lockAspectRatio">鎖定長寬比</label> </div> <div class="dimension-input"> <label for="length-input" data-i18n-key="length">長度 (px)</label> <input type="number" id="length-input" data-i18n-placeholder-key="autoPlaceholder"> </div> <div class="dimension-input"> <label for="width-input" data-i18n-key="width">寬度 (px)</label> <input type="number" id="width-input" data-i18n-placeholder-key="autoPlaceholder"> </div> </div> </div>
            <button id="start-btn" data-i18n-key="startConversion">開始轉換</button>
            <button id="cancel-conversion-btn" class="hidden" data-i18n-key="cancelConversion">取消轉換</button>
        </div>
        <div id="status" data-i18n-key="initialStatus">請先驗證金鑰或使用試用版</div>
        <div id="output-container"> <h2 data-i18n-key="preview">預覽圖片：</h2> <button id="download-all-btn" class="hidden" data-i18n-key="downloadAll">全部下載為 ZIP</button> <div id="image-grid"></div> </div>
    </div>
    
    <div id="plan-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 data-i18n-key="account">帳號資訊</h2>
            <p><span data-i18n-key="currentPlan">目前方案</span>: <strong id="modal-plan-name"></strong></p>
            <button id="view-plans-btn" data-i18n-key="viewPlans">查看方案比較</button>
            <button id="upgrade-btn" data-i18n-key="upgradePlan">升級方案</button>
            <button class="close-btn" data-i18n-key="close">關閉</button>
        </div>
    </div>

    <div id="plans-comparison-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 data-i18n-key="planComparison">方案比較</h2>
            <table class="plans-table">
                <thead>
                    <tr>
                        <th data-i18n-key="feature">功能</th>
                        <th data-i18n-key="planTrial">試用版</th>
                        <th data-i18n-key="planBasic">基礎版</th>
                        <th data-i18n-key="planAdvanced">進階版</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td data-i18n-key="allowPNG">PNG 格式</td>
                        <td><span class="cross">✗</span></td>
                        <td><span class="check">✓</span></td>
                        <td><span class="check">✓</span></td>
                    </tr>
                    <tr>
                        <td data-i18n-key="maxFPS">最高擷取率 (FPS)</td>
                        <td>10</td>
                        <td>30</td>
                        <td>60</td>
                    </tr>
                    <tr>
                        <td data-i18n-key="maxQuality">最高畫質 (JPG)</td>
                        <td>35%</td>
                        <td>75%</td>
                        <td>100%</td>
                    </tr>
                    <tr>
                        <td data-i18n-key="allowCustomSize">自訂尺寸</td>
                        <td><span class="cross">✗</span></td>
                        <td><span class="check">✓</span></td>
                        <td><span class="check">✓</span></td>
                    </tr>
                    <tr>
                        <td data-i18n-key="maxDuration">影片長度限制</td>
                        <td data-i18n-key="durationTrial">30 秒</td>
                        <td data-i18n-key="durationBasic">15 分鐘</td>
                        <td data-i18n-key="durationAdvanced">無限制</td>
                    </tr>
                </tbody>
            </table>
            <button class="close-btn" data-i18n-key="close">關閉</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // ⭐ JS 修改處：新增翻譯詞條
        const translations = {
            'zh-TW': { title: '影片轉圖片工具', theme: '主題', themeLight: '淺色', themeDark: '深色', themeSystem: '視裝置而定', language: '語言', step1: '1. 選擇影片檔案：', step2: '2. 選擇輸出格式：', step3: '3. 選擇擷取率 (FPS)：', step4: '4. 選擇圖片畫質', step4note: '(僅 JPG 有效)：', step5: '5. 選擇輸出尺寸：', useOriginalSize: '使用原始尺寸', useCustomSize: '自訂尺寸', lockAspectRatio: '鎖定長寬比', length: '長度 (px)', width: '寬度 (px)', autoPlaceholder: '自動', startConversion: '開始轉換', initialStatus: '請先驗證金鑰或使用試用版', preview: '預覽圖片：', downloadAll: '全部下載為 ZIP', statusSelected: '已選擇影片：{fileName}。準備開始。', statusInit: '正在初始化...', statusProgress: '已擷取 {count} 張畫格...', statusDone: '處理完成！總共擷取了 {count} 張圖片。', statusZipping: '正在打包 ZIP 檔案...', statusZipped: 'ZIP 檔案已下載！', alertNoVideo: '請先選擇一個影片檔案！', processing: '處理中...', selectFile: '選擇檔案', noFileChosen: '未選擇任何檔案', cancel: '取消', keyPrompt: '請輸入產品金鑰以使用完整功能', keyPlaceholder: 'XXXXX-XXXXX-XXXXX', unlockButton: '驗證金鑰', trialButton: '使用試用版', invalidKeyAlert: '金鑰無效或格式錯誤，請重新輸入！', unlockedStatus: '工具已解鎖。請選擇影片並設定參數。', cancelConversion: '取消轉換', statusCancelled: '轉換已取消。', planDisplay: '目前方案：{plan}', planTrial: '試用版', planBasic: '基礎版', planAdvanced: '進階版', account: '帳號資訊', currentPlan: '目前方案', upgradePlan: '升級方案', upgrade: '升級', close: '關閉', durationWarningText: '您選擇的影片長度超過目前方案限制，只會處理前 {seconds} 秒的內容。\n\n是否要繼續？', viewPlans: '查看方案比較', planComparison: '方案比較', feature: '功能', allowPNG: 'PNG 格式', maxFPS: '最高擷取率 (FPS)', maxQuality: '最高畫質 (JPG)', allowCustomSize: '自訂尺寸', maxDuration: '影片長度限制', durationTrial: '30 秒', durationBasic: '15 分鐘', durationAdvanced: '無限制', alertLimitExceeded: '方案限制警告', limitExceededFPS: '選擇的擷取率 ({value} FPS) 超過方案上限 ({limit} FPS)。', limitExceededQuality: '選擇的畫質 ({value}%) 超過方案上限 ({limit}%)。' },
            'zh-CN': { title: '视频转图片工具', theme: '主题', themeLight: '浅色', themeDark: '深色', themeSystem: '跟随系统', language: '语言', step1: '1. 选择视频文件：', step2: '2. 选择输出格式：', step3: '3. 选择帧率 (FPS)：', step4: '4. 选择图片画质', step4note: '(仅 JPG 有效)：', step5: '5. 选择输出尺寸：', useOriginalSize: '使用原始尺寸', useCustomSize: '自定义尺寸', lockAspectRatio: '锁定长宽比', length: '长度 (px)', width: '宽度 (px)', autoPlaceholder: '自动', startConversion: '开始转换', initialStatus: '请先验证密钥或使用试用版', preview: '预览图片：', downloadAll: '全部下载为 ZIP', statusSelected: '已选择视频：{fileName}。准备开始。', statusInit: '正在初始化...', statusProgress: '已截取 {count} 张图片...', statusDone: '处理完成！总共截取了 {count} 张图片。', statusZipping: '正在打包 ZIP 文件...', statusZipped: 'ZIP 文件已下载！', alertNoVideo: '请先选择一个视频文件！', processing: '处理中...', selectFile: '选择文件', noFileChosen: '未选择任何文件', cancel: '取消', keyPrompt: '请输入产品密钥以使用完整功能', keyPlaceholder: 'XXXXX-XXXXX-XXXXX', unlockButton: '验证密钥', trialButton: '使用试用版', invalidKeyAlert: '密钥无效或格式错误，请重新输入！', unlockedStatus: '工具已解锁。请选择视频并设定参数。', cancelConversion: '取消转换', statusCancelled: '转换已取消。', planDisplay: '当前方案：{plan}', planTrial: '试用版', planBasic: '基础版', planAdvanced: '高级版', account: '帐户信息', currentPlan: '当前方案', upgradePlan: '升级方案', upgrade: '升级', close: '关闭', durationWarningText: '您选择的视频长度超过当前方案限制，只会处理前 {seconds} 秒的内容。\n\n是否要继续？', viewPlans: '查看方案比较', planComparison: '方案比较', feature: '功能', allowPNG: 'PNG 格式', maxFPS: '最高帧率 (FPS)', maxQuality: '最高画质 (JPG)', allowCustomSize: '自定义尺寸', maxDuration: '视频长度限制', durationTrial: '30 秒', durationBasic: '15 分钟', durationAdvanced: '无限制', alertLimitExceeded: '方案限制警告', limitExceededFPS: '选择的帧率 ({value} FPS) 超过方案上限 ({limit} FPS)。', limitExceededQuality: '选择的画质 ({value}%) 超过方案上限 ({limit}%)。' },
            'en': { title: 'Video to Image Converter', theme: 'Theme', themeLight: 'Light', themeDark: 'Dark', themeSystem: 'System', language: 'Language', step1: '1. Select Video File:', step2: '2. Select Output Format:', step3: '3. Select Frame Rate (FPS):', step4: '4. Select Image Quality', step4note: '(JPG only):', step5: '5. Select Output Size:', useOriginalSize: 'Original Size', useCustomSize: 'Custom Size', lockAspectRatio: 'Lock Aspect Ratio', length: 'Length (px)', width: 'Width (px)', autoPlaceholder: 'Auto', startConversion: 'Start Conversion', initialStatus: 'Please validate a key or use the trial version', preview: 'Preview Images:', downloadAll: 'Download All as ZIP', statusSelected: 'Selected video: {fileName}. Ready to start.', statusInit: 'Initializing...', statusProgress: 'Captured {count} frames...', statusDone: 'Completed! Captured a total of {count} images.', statusZipping: 'Zipping files...', statusZipped: 'ZIP file downloaded!', alertNoVideo: 'Please select a video file first!', processing: 'Processing...', selectFile: 'Select File', noFileChosen: 'No file chosen', cancel: 'Cancel', keyPrompt: 'Enter Product Key for Full Features', keyPlaceholder: 'XXXXX-XXXXX-XXXXX', unlockButton: 'Validate Key', trialButton: 'Use Trial Version', invalidKeyAlert: 'Invalid or malformed key, please try again!', unlockedStatus: 'Tool unlocked. Please select a video and set parameters.', cancelConversion: 'Cancel Conversion', statusCancelled: 'Conversion cancelled.', planDisplay: 'Current Plan: {plan}', planTrial: 'Trial', planBasic: 'Basic', planAdvanced: 'Advanced', account: 'Account Info', currentPlan: 'Current Plan', upgradePlan: 'Upgrade Plan', upgrade: 'Upgrade', close: 'Close', durationWarningText: 'The selected video is longer than your plan allows. Only the first {seconds} seconds will be processed.\n\nDo you want to continue?', viewPlans: 'View Plan Comparison', planComparison: 'Plan Comparison', feature: 'Feature', allowPNG: 'PNG Format', maxFPS: 'Max Frame Rate (FPS)', maxQuality: 'Max Quality (JPG)', allowCustomSize: 'Custom Size', maxDuration: 'Video Duration Limit', durationTrial: '30 Seconds', durationBasic: '15 Minutes', durationAdvanced: 'Unlimited', alertLimitExceeded: 'Plan Limit Exceeded', limitExceededFPS: 'Selected FPS ({value}) exceeds your plan limit of {limit} FPS.', limitExceededQuality: 'Selected Quality ({value}%) exceeds your plan limit of {limit}%. ' },
            'ja': { title: '動画画像変換', theme: 'テーマ', themeLight: 'ライト', themeDark: 'ダーク', themeSystem: 'デバイスに従う', language: '言語', step1: '1. 動画ファイルを選択:', step2: '2. 出力形式を選択:', step3: '3. フレームレートを選択 (FPS):', step4: '4. 画質を選択', step4note: '(JPG のみ):', step5: '5. 出力サイズを選択:', useOriginalSize: '元のサイズ', useCustomSize: 'カスタムサイズ', lockAspectRatio: 'アスペクト比を固定', length: '長さ (px)', width: '幅 (px)', autoPlaceholder: '自動', startConversion: '変換開始', initialStatus: 'キーを認証するか、試用版を使用してください', preview: 'プレビュー画像:', downloadAll: 'すべてZIPでダウンロード', statusSelected: '動画を選択しました: {fileName}。準備ができました。', statusInit: '初期化中...', statusProgress: '{count} フレームをキャプチャしました...', statusDone: '完了しました！合計 {count} 枚の画像をキャプチャしました。', statusZipping: 'ZIP ファイルを圧縮中...', statusZipped: 'ZIP ファイルがダウンロードされました！', alertNoVideo: '最初にビデオファイルを選択してください！', processing: '処理中...', selectFile: 'ファイルを選択', noFileChosen: 'ファイルが選択されていません', cancel: 'キャンセル', keyPrompt: '全機能を利用するにはプロダクトキーを入力してください', keyPlaceholder: 'XXXXX-XXXXX-XXXXX', unlockButton: 'キーを認証', trialButton: '試用版を使用', invalidKeyAlert: '無効または形式が正しくないキーです。もう一度お試しください！', unlockedStatus: 'ツールのロックが解除されました。ビデオを選択し、パラメータを設定してください。', cancelConversion: '変換をキャンセル', statusCancelled: '変換はキャンセルされました。', planDisplay: '現在のプラン：{plan}', planTrial: '試用版', planBasic: '基本版', planAdvanced: '上級版', account: 'アカウント情報', currentPlan: '現在のプラン', upgradePlan: 'プランをアップグレード', upgrade: 'アップグレード', close: '閉じる', durationWarningText: '選択した動画は現在のプランの制限を超えています。最初の{seconds}秒のみが処理されます。\n\続行しますか？', viewPlans: 'プラン比較を見る', planComparison: 'プラン比較', feature: '機能', allowPNG: 'PNG形式', maxFPS: '最大フレームレート (FPS)', maxQuality: '最大画質 (JPG)', allowCustomSize: 'カスタムサイズ', maxDuration: '動画の長さの制限', durationTrial: '30秒', durationBasic: '15分', durationAdvanced: '無制限', alertLimitExceeded: 'プラン制限警告', limitExceededFPS: '選択したフレームレート（{value} FPS）がプランの上限（{limit} FPS）を超えています。', limitExceededQuality: '選択した画質（{value}%）がプランの上限（{limit}%）を超えています。' },
            'ko': { title: '비디오 이미지 변환', theme: '테마', themeLight: '라이트', themeDark: '다크', themeSystem: '시스템 설정 따름', language: '언어', step1: '1. 비디오 파일 선택:', step2: '2. 출력 형식 선택:', step3: '3. 프레임 속도 선택 (FPS):', step4: '4. 이미지 품질 선택', step4note: '(JPG만 해당):', step5: '5. 출력 크기 선택:', useOriginalSize: '원본 크기', useCustomSize: '사용자 지정 크기', lockAspectRatio: '종횡비 고정', length: '길이 (px)', width: '너비 (px)', autoPlaceholder: '자동', startConversion: '변환 시작', initialStatus: '키를 인증하거나 평가판을 사용하십시오', preview: '이미지 미리보기:', downloadAll: '모두 ZIP으로 다운로드', statusSelected: '선택된 비디오: {fileName}. 시작 준비 완료.', statusInit: '초기화 중...', statusProgress: '{count} 프레임 캡처됨...', statusDone: '완료! 총 {count}개의 이미지를 캡처했습니다.', statusZipping: 'ZIP 파일 압축 중...', statusZipped: 'ZIP 파일 다운로드 완료!', alertNoVideo: '먼저 비디오 파일을 선택하십시오!', processing: '처리 중...', selectFile: '파일 선택', noFileChosen: '선택된 파일 없음', cancel: '취소', keyPrompt: '전체 기능을 사용하려면 제품 키를 입력하십시오', keyPlaceholder: 'XXXXX-XXXXX-XXXXX', unlockButton: '키 인증', trialButton: '평가판 사용', invalidKeyAlert: '키가 잘못되었거나 형식이 잘못되었습니다. 다시 시도하십시오!', unlockedStatus: '도구가 잠금 해제되었습니다. 비디오를 선택하고 매개변수를 설정하십시오.', cancelConversion: '변환 취소', statusCancelled: '변환이 취소되었습니다.', planDisplay: '현재 플랜: {plan}', planTrial: '평가판', planBasic: '기본', planAdvanced: '고급', account: '계정 정보', currentPlan: '현재 플랜', upgradePlan: '플랜 업그레이드', upgrade: '업그레이드', close: '닫기', durationWarningText: '선택한 비디오가 현재 플랜의 제한을 초과합니다. 처음 {seconds}초만 처리됩니다.\n\n계속하시겠습니까?', viewPlans: '플랜 비교 보기', planComparison: '플랜 비교', feature: '기능', allowPNG: 'PNG 형식', maxFPS: '최대 프레임 속도 (FPS)', maxQuality: '최대 화질 (JPG)', allowCustomSize: '사용자 지정 크기', maxDuration: '비디오 길이 제한', durationTrial: '30초', durationBasic: '15분', durationAdvanced: '무제한', alertLimitExceeded: '플랜 한도 경고', limitExceededFPS: '선택한 FPS({value})가 플랜 한도({limit} FPS)를 초과합니다.', limitExceededQuality: '선택한 품질({value}%)이 플랜 한도({limit}%)를 초과합니다.' }
        };

        function initializeApp() {
            let videoFile = null, originalAspectRatio = 0, lastJpgQuality = 80, currentLang = 'zh-TW';
            let accessLevel = 'locked'; 
            let videoDuration = 0;
            let isCancelled = false;

            const planLimits = {
                trial:    { fps: 10,  quality: 35,  duration: 30,      allowPng: false, allowCustomDim: false },
                basic:    { fps: 30,  quality: 75,  duration: 900,     allowPng: true,  allowCustomDim: true },
                advanced: { fps: 60,  quality: 100, duration: Infinity,  allowPng: true,  allowCustomDim: true },
            };

            const uiElements = {
                settingsBtn: document.getElementById('settings-btn'), settingsMenu: document.getElementById('settings-menu'), themeRadios: document.querySelectorAll('input[name="theme"]'),
                langBtn: document.getElementById('lang-btn'), langMenu: document.getElementById('lang-menu'), langRadios: document.querySelectorAll('input[name="lang"]'),
                statusDiv: document.getElementById('status'), imageGrid: document.getElementById('image-grid'),
                planDisplay: document.getElementById('plan-display'),
                accountBtn: document.getElementById('account-btn'),
                planModal: document.getElementById('plan-modal'),
                modalPlanName: document.getElementById('modal-plan-name'),
                upgradeBtn: document.getElementById('upgrade-btn'),
                viewPlansBtn: document.getElementById('view-plans-btn'),
                plansComparisonModal: document.getElementById('plans-comparison-modal'),
            };
            const keyElements = {
                section: document.getElementById('key-section'), input: document.getElementById('key-input'),
                submitBtn: document.getElementById('key-submit-btn'), trialBtn: document.getElementById('trial-btn'),
            };
            const coreElements = {
                fileSelectionArea: document.getElementById('file-selection-area'),
                controlsContainer: document.querySelector('.controls'),
                videoInput: document.getElementById('video-input'), customFileBtn: document.getElementById('custom-file-btn'), fileNameDisplay: document.getElementById('file-name-display'), cancelFileBtn: document.getElementById('cancel-file-btn'),
                formatRadios: document.querySelectorAll('input[name="format"]'), pngLabel: document.getElementById('png-label'),
                fpsSlider: document.getElementById('fps-slider'), fpsValue: document.getElementById('fps-value'),
                qualitySlider: document.getElementById('quality-slider'), qualityValue: document.getElementById('quality-value'), qualityGroup: document.getElementById('quality-control-group'),
                dimensionRadios: document.querySelectorAll('input[name="dimension-mode"]'), customDimLabel: document.getElementById('custom-dim-label'), customDimensionControls: document.getElementById('custom-dimension-controls'),
                widthInput: document.getElementById('width-input'), lengthInput: document.getElementById('length-input'),
                startBtn: document.getElementById('start-btn'), cancelConversionBtn: document.getElementById('cancel-conversion-btn'), downloadAllBtn: document.getElementById('download-all-btn')
            };
            
            const getTranslation = (key, params = {}) => { let text = (translations[currentLang]?.[key]) || translations['zh-TW'][key] || key; for (const [pKey, pValue] of Object.entries(params)) { text = text.replace(`{${pKey}}`, pValue); } return text; };
            const updateLanguage = (lang) => { currentLang = lang; document.documentElement.lang = lang.split('-')[0]; document.querySelectorAll('[data-i18n-key]').forEach(el => el.textContent = getTranslation(el.dataset.i18nKey)); document.querySelectorAll('[data-i18n-placeholder-key]').forEach(el => el.placeholder = getTranslation(el.dataset.i18nPlaceholderKey)); if(accessLevel !== 'locked') { uiElements.planDisplay.textContent = getTranslation('planDisplay', { plan: getTranslation(`plan${accessLevel.charAt(0).toUpperCase() + accessLevel.slice(1)}`) }); uiElements.modalPlanName.textContent = getTranslation(`plan${accessLevel.charAt(0).toUpperCase() + accessLevel.slice(1)}`); }};
            const applyTheme = (theme) => { if (theme === 'dark') { document.body.setAttribute('data-theme', 'dark'); } else if (theme === 'light') { document.body.removeAttribute('data-theme'); } else { const p = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.toggleAttribute('data-theme', p); } };
            
            const hasUniqueChars = (str) => new Set(str).size === str.length;
            const isAllDigits = (str) => /^\d+$/.test(str);
            const isAllLetters = (str) => /^[A-Z]+$/.test(str);

            function validateKey(key) {
                const parts = key.toUpperCase().split('-');
                if (parts.length !== 3 || parts.some(p => p.length !== 5)) return null;
                const [p1, p2, p3] = parts;

                const isBasic = isAllDigits(p1) && hasUniqueChars(p1) && isAllLetters(p2) && isAllDigits(p3) && hasUniqueChars(p3);
                if (isBasic) return 'basic';

                const isAdvanced = isAllLetters(p1) && hasUniqueChars(p1) && isAllDigits(p2) && isAllLetters(p3) && hasUniqueChars(p3);
                if (isAdvanced) return 'advanced';

                return null;
            }

            // ⭐ JS 修改處：此函式不再調整滑桿的 max 或 value
            function applyLimitations(level) {
                accessLevel = level;
                keyElements.section.style.display = 'none';
                coreElements.controlsContainer.classList.remove('disabled');
                coreElements.fileSelectionArea.classList.add('unlocked');
                uiElements.accountBtn.classList.remove('hidden');

                const planName = getTranslation(`plan${level.charAt(0).toUpperCase() + level.slice(1)}`);
                uiElements.statusDiv.textContent = getTranslation('unlockedStatus');
                uiElements.planDisplay.textContent = getTranslation('planDisplay', { plan: planName });
                uiElements.modalPlanName.textContent = planName;
                
                const limits = planLimits[level];
                const pngRadio = coreElements.pngLabel.querySelector('input');
                const customDimRadio = coreElements.customDimLabel.querySelector('input');

                pngRadio.disabled = !limits.allowPng; 
                coreElements.pngLabel.classList.toggle('disabled', !limits.allowPng);
                if (!limits.allowPng && pngRadio.checked) {
                    coreElements.formatRadios[0].checked = true;
                    coreElements.qualityGroup.classList.remove('disabled');
                }
                
                customDimRadio.disabled = !limits.allowCustomDim; 
                coreElements.customDimLabel.classList.toggle('disabled', !limits.allowCustomDim);
                if (!limits.allowCustomDim && customDimRadio.checked) {
                    coreElements.dimensionRadios[0].checked = true;
                    coreElements.customDimensionControls.classList.add('hidden');
                }
            }

            function setupEventListeners() {
                const menus = [ { btn: uiElements.settingsBtn, menu: uiElements.settingsMenu }, { btn: uiElements.langBtn, menu: uiElements.langMenu } ];
                menus.forEach(item => { item.btn.addEventListener('click', (e) => { e.stopPropagation(); const isOpening = item.menu.classList.contains('hidden'); menus.forEach(other => other.menu.classList.add('hidden')); if (isOpening) item.menu.classList.remove('hidden'); }); item.menu.addEventListener('click', e => e.stopPropagation()); });
                window.addEventListener('click', () => menus.forEach(item => item.menu.classList.add('hidden')));

                keyElements.submitBtn.addEventListener('click', () => {
                    const keyType = validateKey(keyElements.input.value);
                    if (keyType) applyLimitations(keyType); else alert(getTranslation('invalidKeyAlert'));
                });
                keyElements.trialBtn.addEventListener('click', () => applyLimitations('trial'));
                
                // ⭐ JS 修改處：金鑰輸入框自動加上 '-'
                keyElements.input.addEventListener('input', (e) => {
                    let input = e.target;
                    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    let formattedValue = '';
                    if (value.length > 0) {
                        formattedValue = value.match(/.{1,5}/g).join('-');
                    }
                    input.value = formattedValue;
                });
                
                uiElements.accountBtn.addEventListener('click', () => uiElements.planModal.classList.remove('hidden'));
                uiElements.planModal.querySelector('.close-btn').addEventListener('click', () => uiElements.planModal.classList.add('hidden'));
                uiElements.upgradeBtn.addEventListener('click', () => { uiElements.planModal.classList.add('hidden'); keyElements.section.style.display = 'block'; });
                
                uiElements.viewPlansBtn.addEventListener('click', () => {
                    uiElements.planModal.classList.add('hidden');
                    uiElements.plansComparisonModal.classList.remove('hidden');
                });
                uiElements.plansComparisonModal.querySelector('.close-btn').addEventListener('click', () => uiElements.plansComparisonModal.classList.add('hidden'));

                uiElements.themeRadios.forEach(r => r.addEventListener('change', e => { localStorage.setItem('theme', e.target.value); applyTheme(e.target.value); }));
                uiElements.langRadios.forEach(r => r.addEventListener('change', e => { localStorage.setItem('language', e.target.value); updateLanguage(e.target.value); }));

                coreElements.customFileBtn.addEventListener('click', () => coreElements.videoInput.click());

                coreElements.videoInput.addEventListener('change', (event) => {
                    videoFile = event.target.files[0];
                    if (videoFile) {
                        const vURL = URL.createObjectURL(videoFile); const video = document.createElement('video');
                        video.addEventListener('loadedmetadata', () => { 
                            videoDuration = video.duration;
                            uiElements.statusDiv.textContent = getTranslation('statusSelected', {fileName: videoFile.name}); 
                            coreElements.fileNameDisplay.textContent = videoFile.name; 
                            coreElements.fileNameDisplay.style.opacity = '1'; 
                            coreElements.cancelFileBtn.classList.remove('hidden');
                            originalAspectRatio = video.videoWidth / video.videoHeight; 
                            coreElements.widthInput.placeholder = video.videoWidth; 
                            coreElements.lengthInput.placeholder = video.videoHeight; 
                            URL.revokeObjectURL(vURL); 
                        }, { once: true });
                        video.src = vURL;
                    }
                });

                coreElements.cancelFileBtn.addEventListener('click', () => { videoFile = null; coreElements.videoInput.value = ''; coreElements.fileNameDisplay.textContent = getTranslation('noFileChosen'); coreElements.fileNameDisplay.style.opacity = '0.7'; coreElements.cancelFileBtn.classList.add('hidden'); uiElements.statusDiv.textContent = getTranslation('unlockedStatus'); });
                coreElements.fpsSlider.addEventListener('input', (e) => coreElements.fpsValue.textContent = e.target.value);
                coreElements.qualitySlider.addEventListener('input', (e) => { coreElements.qualityValue.textContent = e.target.value; lastJpgQuality = e.target.value; });
                coreElements.formatRadios.forEach(r => r.addEventListener('change', e => { const isJpg = e.target.value === 'image/jpeg'; coreElements.qualityGroup.classList.toggle('disabled', !isJpg); coreElements.qualityGroup.style.opacity = isJpg ? '1' : '0.5'; if (isJpg) { coreElements.qualitySlider.value = lastJpgQuality; coreElements.qualityValue.textContent = lastJpgQuality; } else { coreElements.qualitySlider.value = 100; coreElements.qualityValue.textContent = '100'; } }));
                coreElements.dimensionRadios.forEach(r => r.addEventListener('change', e => coreElements.customDimensionControls.classList.toggle('hidden', e.target.value !== 'custom')));
                
                coreElements.startBtn.addEventListener('click', () => { if (!videoFile) { alert(getTranslation('alertNoVideo')); return; } startConversion(); });
                coreElements.cancelConversionBtn.addEventListener('click', () => { isCancelled = true; });
                coreElements.downloadAllBtn.addEventListener('click', downloadAllImages);
            }
            
            async function startConversion() {
                // ⭐ JS 新增處：在開始轉換前，檢查設定是否超過方案限制
                const limits = planLimits[accessLevel];
                const selectedFps = parseInt(coreElements.fpsSlider.value, 10);
                const selectedQuality = parseInt(coreElements.qualitySlider.value, 10);
                const isJpg = document.querySelector('input[name="format"]:checked').value === 'image/jpeg';

                const errors = [];
                if (selectedFps > limits.fps) {
                    errors.push(getTranslation('limitExceededFPS', { value: selectedFps, limit: limits.fps }));
                }
                if (isJpg && selectedQuality > limits.quality) {
                    errors.push(getTranslation('limitExceededQuality', { value: selectedQuality, limit: limits.quality }));
                }

                if (errors.length > 0) {
                    alert(`${getTranslation('alertLimitExceeded')}:\n\n- ${errors.join('\n- ')}`);
                    return; // 阻止轉換
                }

                if (videoDuration > limits.duration) {
                    const proceed = confirm(getTranslation('durationWarningText', { seconds: limits.duration }));
                    if (!proceed) return;
                }
                
                isCancelled = false;
                coreElements.startBtn.classList.add('hidden');
                coreElements.cancelConversionBtn.classList.remove('hidden');
                uiElements.statusDiv.textContent = getTranslation('statusInit'); 
                uiElements.imageGrid.innerHTML = ''; 
                coreElements.downloadAllBtn.classList.add('hidden');

                const vURL = URL.createObjectURL(videoFile); 
                const video = document.createElement('video'); 
                video.muted = true;

                video.addEventListener('loadedmetadata', async () => {
                    const duration = Math.min(video.duration, limits.duration);
                    const selectedFormat = document.querySelector('input[name="format"]:checked').value; 
                    const quality = selectedQuality / 100; 
                    const fps = selectedFps; 
                    const interval = 1 / fps;
                    const dimMode = document.querySelector('input[name="dimension-mode"]:checked').value; 
                    let oW, oL;
                    if (dimMode === 'original' || !planLimits[accessLevel].allowCustomDim) { oW = video.videoWidth; oL = video.videoHeight; } 
                    else { oW = parseInt(coreElements.widthInput.value, 10) || video.videoWidth; oL = parseInt(coreElements.lengthInput.value, 10) || video.videoHeight; }
                    
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); 
                    canvas.width = oW; canvas.height = oL;
                    let cFrames = 0;
                    
                    try {
                        for (let cTime = 0; cTime < duration; cTime += interval) {
                            if (isCancelled) break;
                            video.currentTime = cTime; 
                            await new Promise(r => video.addEventListener('seeked', r, { once: true }));
                            ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, oW, oL);
                            let dUrl = (selectedFormat === 'image/jpeg') ? canvas.toDataURL(selectedFormat, quality) : canvas.toDataURL(selectedFormat);
                            const img = document.createElement('img'); img.src = dUrl; img.classList.add('thumbnail'); img.title = `Time: ${cTime.toFixed(2)}s`; 
                            uiElements.imageGrid.appendChild(img);
                            cFrames++; 
                            uiElements.statusDiv.textContent = getTranslation('statusProgress', {count: cFrames});
                        }
                        if (isCancelled) uiElements.statusDiv.textContent = getTranslation('statusCancelled');
                        else { uiElements.statusDiv.textContent = getTranslation('statusDone', {count: cFrames}); if (cFrames > 0) coreElements.downloadAllBtn.classList.remove('hidden'); }
                    } finally {
                        coreElements.startBtn.classList.remove('hidden');
                        coreElements.cancelConversionBtn.classList.add('hidden');
                        URL.revokeObjectURL(vURL);
                    }
                });
                video.src = vURL; 
                video.load();
            }

            async function downloadAllImages() {
                uiElements.statusDiv.textContent = getTranslation('statusZipping'); 
                const zip = new JSZip(); 
                const images = uiElements.imageGrid.querySelectorAll('img');
                const selFmt = document.querySelector('input[name="format"]:checked').value; 
                const ext = selFmt === 'image/jpeg' ? 'jpg' : 'png';
                images.forEach((img, i) => { const b64 = img.src.split(',')[1]; zip.file(`frame_${String(i + 1).padStart(4, '0')}.${ext}`, b64, { base64: true }); });
                const content = await zip.generateAsync({ type: "blob" }); 
                const vName = videoFile.name.split('.').slice(0, -1).join('.'); 
                let zipName = `${vName}_frames_${ext}`; 
                if (ext === 'jpg') zipName += `_q${coreElements.qualitySlider.value}`;
                saveAs(content, `${zipName}.zip`); 
                uiElements.statusDiv.textContent = getTranslation('statusZipped');
            }

            const savedTheme = localStorage.getItem('theme') || 'system'; document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true; applyTheme(savedTheme);
            const savedLang = localStorage.getItem('language') || navigator.language || 'zh-TW'; let matchedLang = Object.keys(translations).find(k => savedLang.startsWith(k)) || 'zh-TW'; document.querySelector(`input[name="lang"][value="${matchedLang}"]`).checked = true; updateLanguage(matchedLang);
            setupEventListeners();
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>